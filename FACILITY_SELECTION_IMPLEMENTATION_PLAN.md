# 施設選択機能 実装計画

## 実装可能性の評価

### ✅ 実装可能

以下の機能は実装可能です：

1. **施設選択ページの作成** - ✅ 可能
   - Next.js App Routerを使用しているため、新しいページルートを作成可能
   - 既存の施設API (`/api/facilities`) を活用可能

2. **選択した施設でのフィルタリング** - ✅ 可能
   - 状態管理方法：localStorage/sessionStorage + Context APIの組み合わせを推奨
   - 選択した施設IDを保持し、各コンポーネントで参照可能

3. **サイドバーのフィルタリング** - ✅ 可能
   - Sidebarコンポーネントで選択された施設IDを取得し、表示をフィルタリング

4. **マスタ画面のフィルタリング** - ✅ 可能
   - MasterPageで選択された施設IDを取得し、API呼び出し時にフィルタリング

## 実装計画

### フェーズ1: 状態管理の基盤構築

#### 1.1 施設選択状態管理用のContext作成
- **ファイル**: `contexts/FacilityContext.tsx` (新規作成)
- **機能**:
  - 選択された施設IDを管理
  - localStorageに保存（ページリロード後も保持）
  - 施設選択の変更を通知
  - 全コンポーネントからアクセス可能なProvider

#### 1.2 RootLayoutへのProvider追加
- **ファイル**: `app/layout.tsx` (修正)
- **変更内容**:
  - FacilityContext.Providerでアプリ全体をラップ

### フェーズ2: 施設選択ページの作成

#### 2.1 施設選択ページの作成
- **ファイル**: `app/facility-select/page.tsx` (新規作成)
- **機能**:
  - アクティブな施設の一覧を表示
  - カード形式またはリスト形式で施設を表示
  - 施設をクリックして選択
  - 選択後、法人ダッシュボード (`/`) にリダイレクト
  - 「法人全体を表示」オプション（施設選択を解除）

#### 2.2 ルーティングの変更
- **ファイル**: `app/page.tsx` (修正)
- **変更内容**:
  - 施設が選択されていない場合、施設選択ページにリダイレクト
  - または、ミドルウェアでリダイレクト処理

#### 2.3 施設選択ページのスタイリング
- 既存のCardコンポーネントを活用
- MainLayoutは使用しない（サイドバーなしのシンプルなレイアウト）

### フェーズ3: サイドバーのフィルタリング

#### 3.1 Sidebarコンポーネントの修正
- **ファイル**: `components/Sidebar.tsx` (修正)
- **変更内容**:
  - FacilityContextから選択された施設IDを取得
  - 施設一覧セクションで、選択された施設のみを表示
  - または、選択された施設をハイライト表示
  - 「施設選択を変更」リンクを追加（`/facility-select`へ）

### フェーズ4: マスタ画面のフィルタリング

#### 4.1 MasterPageの修正
- **ファイル**: `app/master/page.tsx` (修正)
- **変更内容**:
  - FacilityContextから選択された施設IDを取得
  - 施設マスタタブ: 選択された施設のみ表示（または選択された施設をハイライト）
  - ユニットマスタタブ: 選択された施設のユニットのみ表示
  - 利用者マスタタブ: 選択された施設の利用者のみ表示
  - API呼び出し時に `facilityId` パラメータを追加

#### 4.2 APIエンドポイントの修正
- **ファイル**: 
  - `app/api/units/route.ts` (修正)
  - `app/api/residents/route.ts` (修正)
- **変更内容**:
  - `facilityId` クエリパラメータを受け取り、フィルタリング
  - 既存の `includeInactive` パラメータと併用可能に

### フェーズ5: その他の画面への影響確認と修正

#### 5.1 法人ダッシュボードの修正
- **ファイル**: `app/page.tsx` (修正)
- **変更内容**:
  - 選択された施設がある場合、その施設の情報のみ表示
  - または、選択された施設をハイライト表示
  - API呼び出し時に `facilityId` パラメータを追加

#### 5.2 ダッシュボードAPIの修正
- **ファイル**: `app/api/dashboard/route.ts` (修正)
- **変更内容**:
  - `facilityId` クエリパラメータを受け取り、フィルタリング

#### 5.3 その他の画面への影響
- **ファイル**: 
  - `app/print/page.tsx` (確認・必要に応じて修正)
  - `app/cash-verification/page.tsx` (確認・必要に応じて修正)
- **確認内容**:
  - 施設選択の影響を受けるか確認
  - 必要に応じてフィルタリングを追加

### フェーズ6: UI/UXの改善

#### 6.1 施設選択状態の表示
- サイドバーまたはヘッダーに現在選択中の施設名を表示
- 施設選択を変更するボタン/リンクを追加

#### 6.2 ナビゲーションの改善
- 施設選択ページへのアクセス方法を明確化
- ブラウザの戻るボタンでの動作確認

## 技術的な考慮事項

### 状態管理の方法
1. **Context API + localStorage** (推奨)
   - シンプルでNext.jsと相性が良い
   - ページリロード後も状態を保持
   - サーバーサイドレンダリング時の考慮が必要

2. **URLパラメータ**
   - ブックマーク可能
   - ブラウザの戻る/進むで動作
   - ただし、すべてのページでパラメータを維持する必要がある

3. **Cookie**
   - サーバーサイドでもアクセス可能
   - ただし、クライアントサイドでの使用が主なため、Context + localStorageで十分

### 実装上の注意点

1. **サーバーサイドレンダリング (SSR)**
   - Context APIはクライアントサイドのみで動作
   - `'use client'` ディレクティブが必要
   - 初期レンダリング時は施設未選択状態を想定

2. **パフォーマンス**
   - 施設選択の変更時に必要なコンポーネントのみ再レンダリング
   - useMemo/useCallbackを適切に使用

3. **エラーハンドリング**
   - 選択された施設が削除/無効化された場合の処理
   - 施設データの取得失敗時の処理

4. **アクセシビリティ**
   - 施設選択ページでのキーボードナビゲーション
   - スクリーンリーダー対応

## 実装順序の推奨

1. **フェーズ1**: 状態管理の基盤構築
2. **フェーズ2**: 施設選択ページの作成
3. **フェーズ3**: サイドバーのフィルタリング
4. **フェーズ4**: マスタ画面のフィルタリング
5. **フェーズ5**: その他の画面への影響確認と修正
6. **フェーズ6**: UI/UXの改善

## 想定される作業時間

- フェーズ1: 1-2時間
- フェーズ2: 2-3時間
- フェーズ3: 1-2時間
- フェーズ4: 3-4時間
- フェーズ5: 2-3時間
- フェーズ6: 1-2時間

**合計**: 約10-16時間

## リスクと対策

### リスク1: 既存機能への影響
- **対策**: 段階的な実装とテスト
- 各フェーズで既存機能が正常に動作することを確認

### リスク2: 状態管理の複雑化
- **対策**: Context APIをシンプルに保つ
- 必要に応じてカスタムフックを作成

### リスク3: パフォーマンスの低下
- **対策**: 不要な再レンダリングを避ける
- React DevToolsでパフォーマンスを監視

## 次のステップ

実装を開始する場合は、フェーズ1から順番に進めることを推奨します。
各フェーズの完了後に動作確認を行い、問題がなければ次のフェーズに進みます。
