# 期間絞り込みの効果分析

## 調査日: 2026年2月3日

## ユーザーの理解（正しい）

**最新の月を見る場合**: 効果が小さい
**過去の月を見る場合**: 効果が大きい

---

## 現状の問題点

### 全取引を取得している

```typescript
// app/api/facilities/[id]/route.ts (現状)
transactions: {
  select: { ... },
  orderBy: { transactionDate: 'asc' },
  // where句での期間絞り込みがない = 全取引を取得
}
```

**問題**:
- 指定年月に関係なく、**全期間の取引を取得**
- 過去の月を見る場合、不要な未来の取引も取得してしまう

---

## 具体例

### ケース1: 最新の月（2026年2月）を見る場合

**必要な取引**: 2026年2月28日までの取引

**現状の取得**:
- 全取引（2026年2月28日までの取引も含む）
- データ量: 全期間分

**期間絞り込み後**:
- 2026年2月28日までの取引
- データ量: 全期間分（ほぼ同じ）

**効果**: ⚠️ **小さい**
- 最新の月を見る場合、ほぼ全取引が必要
- 削減できるデータ量は少ない

---

### ケース2: 過去の月（2025年10月）を見る場合

**必要な取引**: 2025年10月31日までの取引

**現状の取得**:
- 全取引（2025年10月31日〜2026年2月28日までの取引）
- データ量: 全期間分

**期間絞り込み後**:
- 2025年10月31日までの取引
- データ量: 2025年10月31日まで

**効果**: ✅ **大きい**
- 2025年11月〜2026年2月の取引（約4ヶ月分）を削減可能
- データ転送量が大幅に削減される

---

### ケース3: 2025年9月に入った人の2025年10月分を表示

**必要な取引**: 2025年10月31日までの取引

**現状の取得**:
- 全取引（2025年9月〜2026年2月28日までの取引）
- データ量: 約6ヶ月分

**期間絞り込み後**:
- 2025年10月31日までの取引
- データ量: 約2ヶ月分（2025年9月〜10月）

**削減できる期間**: 2025年11月1日 〜 2026年2月28日（約4ヶ月分）

**削減率**: 約67%削減（6ヶ月分 → 2ヶ月分）

---

## 効果の比較

| 表示する月 | 必要な取引 | 現状の取得 | 削減できる期間 | 効果 |
|-----------|-----------|-----------|--------------|------|
| 2026年2月（最新） | 2026年2月28日まで | 全期間 | なし | ⚠️ 小さい |
| 2026年1月 | 2026年1月31日まで | 全期間 | 2026年2月（約1ヶ月） | ✅ 中程度 |
| 2025年12月 | 2025年12月31日まで | 全期間 | 2026年1月〜2月（約2ヶ月） | ✅ 大きい |
| 2025年10月 | 2025年10月31日まで | 全期間 | 2025年11月〜2026年2月（約4ヶ月） | ✅ 非常に大きい |
| 2025年1月 | 2025年1月31日まで | 全期間 | 2025年2月〜2026年2月（約13ヶ月） | ✅ 非常に大きい |

---

## 結論

**ユーザーの理解は完全に正しい**

1. **最新の月を見る場合**: 効果が小さい
   - ほぼ全取引が必要なため、削減できるデータ量が少ない

2. **過去の月を見る場合**: 効果が大きい
   - 不要な未来の取引を削減できる
   - 過去に遡るほど効果が大きくなる

3. **特に効果が大きいケース**:
   - 過去の月を表示する場合
   - 過去に入った人の過去の月を表示する場合
   - システムが長期間運用されている場合

---

## 実装の価値

**期間絞り込みは実装すべき**

理由:
1. **過去データが多い場合に効果が大きい**
   - システムが長期間運用されている場合、効果が大きくなる
   - 過去の月を表示する頻度が高い場合、効果が大きい

2. **データベースの負荷軽減**
   - 不要なデータを取得しないことで、データベースの負荷が軽減される
   - 特にインデックスが適切に設定されている場合、効果が大きい

3. **ネットワーク転送量の削減**
   - 不要なデータを転送しないことで、ネットワーク転送量が削減される
   - モバイル環境など、帯域幅が限られている場合に効果が大きい

4. **メモリ使用量の削減**
   - 不要なデータをメモリに保持しないことで、メモリ使用量が削減される
   - 大量のデータを扱う場合に効果が大きい

---

## 推奨

**①②③すべて実装すべき**

- 実装が比較的簡単
- 過去データが多い場合に効果が大きい
- リスクが低い（正しく実装すれば問題ない）
- システムが長期間運用されるほど効果が大きくなる
