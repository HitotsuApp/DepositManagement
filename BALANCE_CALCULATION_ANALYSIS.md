# 残高計算ロジックの分析

## 調査日: 2026年2月3日

## 重要な発見

### `calculateBalanceUpToMonth` 関数の動作

```typescript
const targetDate = new Date(year, month, 0, 23, 59, 59, 999)
```

**重要なポイント**:
- `month` パラメータは **1から始まる**（1=1月、2=2月、...）
- JavaScriptの `Date` コンストラクタは **0から始まる**（0=1月、1=2月、...）

**例: 2月の残高を計算する場合**
- `year=2026, month=2` (2月)
- `new Date(2026, 2, 0)` = 2026年3月0日 = **2026年2月28日23:59:59.999**

**これは正しい！**
- 2月の残高を計算するには、**2月28日までの取引**が必要
- これは**1月31日までの取引（先月までの残高）も含む**

---

## 期間絞り込みの可否

### ① `app/api/facilities/[id]/route.ts` (GET)

**現状**:
- 全取引を取得
- `calculateBalanceUpToMonth(resident.transactions, year, month)` で残高を計算

**期間絞り込み後**:
- 指定年月の最終日までの取引のみを取得
- `where: { transactionDate: { lte: new Date(year, month, 0, 23, 59, 59, 999) } }`

**検証**:
- `year=2026, month=2` (2月) の場合
- `targetDate = new Date(2026, 2, 0, 23, 59, 59, 999)` = 2026年2月28日23:59:59.999
- この日付までの取引を取得すれば、**1月31日までの取引（先月までの残高）も含まれる**

**結論**: ✅ **期間絞り込み可能**
- 先月までの残高も正しく計算される
- 指定年月の最終日までの取引を取得すれば十分

---

## 残高確定のロジック

### `calculateBalanceUpToMonth` の動作

1. **targetDateの計算**:
   ```typescript
   const targetDate = new Date(year, month, 0, 23, 59, 59, 999)
   ```
   - 指定年月の最終日23:59:59.999を計算

2. **取引のフィルタリング**:
   ```typescript
   if (transactionDate <= targetDate) {
     // 残高計算に含める
   }
   ```
   - 指定年月の最終日までの取引のみを処理

3. **累積残高の計算**:
   - 取引を日付順にソート
   - 最初から順番に累積残高を計算
   - `correct_in`/`correct_out` は除外
   - `past_correct_in`/`past_correct_out` は含める

**重要なポイント**:
- **先月までの残高は自動的に含まれる**
- 指定年月の最終日までの取引を取得すれば、先月までの取引も含まれる
- 累積計算のため、過去の取引も必要

---

## 具体例

### 2月の残高を計算する場合

**必要な取引**:
- 1月1日〜1月31日の取引（先月までの残高）
- 2月1日〜2月28日の取引（当月の取引）

**期間絞り込み**:
```typescript
where: {
  transactionDate: {
    lte: new Date(2026, 2, 0, 23, 59, 59, 999) // 2026年2月28日23:59:59.999
  }
}
```

**結果**:
- ✅ 1月1日〜1月31日の取引も取得される
- ✅ 2月1日〜2月28日の取引も取得される
- ✅ 先月までの残高も正しく計算される

---

## 結論

**①は期間絞り込み可能**

- `calculateBalanceUpToMonth` は指定年月の最終日までの取引を処理する
- 期間絞り込みで指定年月の最終日までの取引を取得すれば、**先月までの残高も自動的に含まれる**
- 全取引を取得する必要はない

**残高確定のロジック**:
- `calculateBalanceUpToMonth` 関数が残高を確定する
- 指定年月の最終日までの取引を取得すれば、先月までの残高も正しく計算される
