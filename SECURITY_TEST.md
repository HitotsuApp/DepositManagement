# 預り金管理システム セキュリティテスト計画書

## 1. テスト目的

自由入力できるテキスト欄からの攻撃（SQLインジェクション、XSS、その他のインジェクション攻撃）を防ぐためのセキュリティテストを実施します。

## 2. 対象となる自由入力欄

### 2.1 マスタ管理画面
- **施設名** (`facility.name`)
- **役職名** (`facility.positionName`)
- **役職者の名前** (`facility.positionHolderName`)
- **ユニット名** (`unit.name`)
- **利用者名** (`resident.name`)

### 2.2 取引登録画面
- **内容（備考）** (`transaction.description`)
- **支払先** (`transaction.payee`)
- **理由** (`transaction.reason`) - 訂正入力時

### 2.3 データインポート画面
- **CSVデータ** (textarea) - 施設名、ユニット名、利用者名などが含まれる

## 3. テスト対象の攻撃パターン

### 3.1 SQLインジェクション
Prisma ORMを使用しているため、SQLインジェクションのリスクは低いですが、念のため確認します。

### 3.2 XSS (Cross-Site Scripting)
- ストアドXSS（データベースに保存された悪意のあるスクリプト）
- リフレクテッドXSS（URLパラメータなど）

### 3.3 その他のインジェクション攻撃
- NoSQLインジェクション（該当なし）
- コマンドインジェクション（該当なし）
- パストラバーサル（該当なし）

## 4. テスト項目

### 4.1 SQLインジェクション対策テスト

#### SEC-001: SQLインジェクション攻撃（施設名）
- **前提条件**: マスタ管理画面が表示されている
- **攻撃パターン**: 
  ```
  施設名: ' OR '1'='1
  施設名: '; DROP TABLE Facility; --
  施設名: ' UNION SELECT * FROM Resident --
  ```
- **期待結果**: 
  - エラーメッセージが表示される、または入力がサニタイズされる
  - データベースが破壊されない
  - SQLが実行されない
- **優先度**: Critical

#### SEC-002: SQLインジェクション攻撃（利用者名）
- **前提条件**: マスタ管理画面が表示されている
- **攻撃パターン**: 
  ```
  利用者名: ' OR '1'='1
  利用者名: '; DROP TABLE Transaction; --
  ```
- **期待結果**: 
  - エラーメッセージが表示される、または入力がサニタイズされる
  - データベースが破壊されない
- **優先度**: Critical

#### SEC-003: SQLインジェクション攻撃（取引の備考）
- **前提条件**: 利用者詳細画面で取引登録モーダルが開いている
- **攻撃パターン**: 
  ```
  内容（備考）: ' OR '1'='1
  内容（備考）: '; DELETE FROM Transaction; --
  ```
- **期待結果**: 
  - エラーメッセージが表示される、または入力がサニタイズされる
  - データベースが破壊されない
- **優先度**: Critical

### 4.2 XSS対策テスト

#### SEC-101: ストアドXSS攻撃（施設名）
- **前提条件**: マスタ管理画面が表示されている
- **攻撃パターン**: 
  ```
  施設名: <script>alert('XSS')</script>
  施設名: <img src=x onerror=alert('XSS')>
  施設名: <svg onload=alert('XSS')>
  施設名: javascript:alert('XSS')
  ```
- **期待結果**: 
  - スクリプトが実行されない
  - HTMLタグがエスケープされて表示される
  - アラートが表示されない
- **優先度**: High

#### SEC-102: ストアドXSS攻撃（利用者名）
- **前提条件**: マスタ管理画面が表示されている
- **攻撃パターン**: 
  ```
  利用者名: <script>document.cookie</script>
  利用者名: <iframe src="javascript:alert('XSS')"></iframe>
  ```
- **期待結果**: 
  - スクリプトが実行されない
  - HTMLタグがエスケープされて表示される
- **優先度**: High

#### SEC-103: ストアドXSS攻撃（取引の備考）
- **前提条件**: 利用者詳細画面で取引登録モーダルが開いている
- **攻撃パターン**: 
  ```
  内容（備考）: <script>alert('XSS')</script>
  内容（備考）: <img src=x onerror=alert('XSS')>
  ```
- **期待結果**: 
  - スクリプトが実行されない
  - HTMLタグがエスケープされて表示される
- **優先度**: High

#### SEC-104: XSS攻撃（支払先）
- **前提条件**: 利用者詳細画面で取引登録モーダルが開いている
- **攻撃パターン**: 
  ```
  支払先: <script>alert('XSS')</script>
  支払先: <img src=x onerror=alert('XSS')>
  ```
- **期待結果**: 
  - スクリプトが実行されない
  - HTMLタグがエスケープされて表示される
- **優先度**: High

#### SEC-105: XSS攻撃（理由）
- **前提条件**: 利用者詳細画面で訂正入力モーダルが開いている
- **攻撃パターン**: 
  ```
  理由: <script>alert('XSS')</script>
  理由: <img src=x onerror=alert('XSS')>
  ```
- **期待結果**: 
  - スクリプトが実行されない
  - HTMLタグがエスケープされて表示される
- **優先度**: High

### 4.3 CSVインポート攻撃テスト

#### SEC-201: CSVインポートでのSQLインジェクション
- **前提条件**: データインポート画面が表示されている
- **攻撃パターン**: 
  ```
  施設名,ユニット名,利用者名,残高
  ' OR '1'='1,ユニット1,利用者1,100000
  施設A,'; DROP TABLE Unit; --,利用者2,50000
  ```
- **期待結果**: 
  - エラーメッセージが表示される
  - データベースが破壊されない
- **優先度**: Critical

#### SEC-202: CSVインポートでのXSS
- **前提条件**: データインポート画面が表示されている
- **攻撃パターン**: 
  ```
  施設名,ユニット名,利用者名,残高
  <script>alert('XSS')</script>,ユニット1,利用者1,100000
  施設A,<img src=x onerror=alert('XSS')>,利用者2,50000
  ```
- **期待結果**: 
  - データがインポートされる場合、HTMLタグがエスケープされて表示される
  - スクリプトが実行されない
- **優先度**: High

### 4.4 入力長制限テスト

#### SEC-301: 非常に長い文字列の入力
- **前提条件**: 各入力画面が表示されている
- **攻撃パターン**: 
  ```
  施設名: A * 10000 (10000文字)
  利用者名: A * 10000 (10000文字)
  内容（備考）: A * 10000 (10000文字)
  ```
- **期待結果**: 
  - データベースの制約でエラーが発生する、または入力が制限される
  - システムがクラッシュしない
- **優先度**: Medium

### 4.5 特殊文字のテスト

#### SEC-401: 特殊文字の入力
- **前提条件**: 各入力画面が表示されている
- **攻撃パターン**: 
  ```
  施設名: !@#$%^&*()_+-=[]{}|;':\",./<>?
  利用者名: null, undefined, NaN
  内容（備考）: \0, \n, \r, \t
  ```
- **期待結果**: 
  - エラーが発生しない、または適切に処理される
  - データが正しく保存される
- **優先度**: Medium

## 5. 現在の実装状況の確認

### 5.1 Prisma ORMの使用
- ✅ Prisma ORMを使用しているため、SQLインジェクションのリスクは低い
- Prismaはパラメータ化クエリを使用するため、SQLインジェクションを防ぐ

### 5.2 Reactのデフォルト動作
- ⚠️ ReactはデフォルトでXSSを防ぐ（`dangerouslySetInnerHTML`を使用しない限り）
- ただし、データベースに保存された悪意のあるスクリプトが表示される可能性がある

### 5.3 入力バリデーション
- ⚠️ 一部のフィールドで`trim()`が使用されているが、サニタイゼーションは確認が必要

## 6. 推奨される対策

### 6.1 即座に対応すべき事項
1. **XSS対策の確認**
   - Reactのデフォルト動作でXSSは防がれているが、念のため確認
   - `dangerouslySetInnerHTML`が使用されていないことを確認

2. **入力長制限の実装**
   - データベーススキーマで最大長を設定
   - フロントエンドでも入力長を制限

3. **特殊文字の処理**
   - 必要に応じてサニタイゼーションを実装

### 6.2 改善推奨事項
1. **CSP (Content Security Policy) の設定**
   - XSS攻撃をさらに防ぐため

2. **入力バリデーションの強化**
   - 正規表現による入力検証
   - 許可リスト方式の採用

3. **ログの記録**
   - 不正な入力の試みをログに記録

## 7. テスト実施方法

### 7.1 手動テスト
1. 各入力欄に攻撃パターンを入力
2. データベースの状態を確認
3. 画面表示を確認
4. ブラウザのコンソールでエラーを確認

### 7.2 自動テスト（将来の拡張）
- OWASP ZAPなどのセキュリティスキャンツールの使用
- 自動化されたセキュリティテストの導入

## 8. テスト結果の記録

テスト結果は `SECURITY_TEST_RESULTS.md` に記録します。
