# 施設・利用者無効化時の動作について

## 現在の実装状況

### 1. 施設を無効化した場合

#### ✅ 正常に動作している部分
- **施設選択画面**: 無効化された施設は選択リストに表示されない
  - `facility-select/page.tsx`で`data.filter((f: Facility) => f.isActive)`によりフィルタリング
- **ダッシュボード**: 無効化された施設は表示されない
  - `/api/dashboard`で`isActive: true`の施設のみを取得
- **サイドバー**: 無効化された施設は表示されない
  - `Sidebar.tsx`でアクティブな施設のみをフィルタリング

#### ⚠️ 潜在的な問題
1. **既に選択されている施設が無効化された場合**
   - `localStorage`に施設IDが残っているため、選択状態が維持される可能性がある
   - ダッシュボードや施設詳細画面にアクセスできる可能性がある
   - ただし、ダッシュボードAPIでは無効化された施設は表示されないため、データが空になる可能性がある

2. **施設詳細画面のAPI**
   - `/api/facilities/[id]`では、`isActive`のチェックがない
   - 無効化された施設でも、直接URLにアクセスすれば表示できる可能性がある
   - ただし、利用者やユニットは`isActive: true`のみを取得するため、データは空になる

### 2. 利用者を無効化した場合

#### ✅ 正常に動作している部分
- **施設詳細画面**: 無効化された利用者は表示されない
  - `/api/facilities/[id]`で`isActive: true`の利用者のみを取得
- **ダッシュボード**: 無効化された利用者の残高は計算に含まれない
  - `/api/dashboard`で`isActive: true`の利用者のみを取得
- **利用者詳細画面**: 無効化された利用者は表示されない
  - `/api/residents`で`isActive: true`の利用者のみを取得

#### ⚠️ 潜在的な問題
1. **既に選択されている利用者のページにアクセスしている場合**
   - 直接URLにアクセスすれば、無効化された利用者のページを表示できる可能性がある
   - ただし、取引データは表示されるため、過去データの確認は可能

## 推奨される改善

### 改善案1: 選択されている施設が無効化された場合の処理
- ダッシュボードや施設詳細画面で、選択されている施設が無効化されている場合、警告を表示
- または、自動的に施設選択画面にリダイレクト

### 改善案2: 施設詳細画面APIでの無効化チェック
- `/api/facilities/[id]`で、施設が無効化されている場合、エラーを返す
- または、警告メッセージを返す

### 改善案3: 利用者詳細画面APIでの無効化チェック
- `/api/residents/[id]`で、利用者が無効化されている場合、エラーを返す
- または、警告メッセージを返す

## 現在の動作まとめ

### 施設を無効化した場合
- ✅ **施設選択画面**: 選択できなくなる（表示されない）
- ✅ **ダッシュボード**: 表示されない
- ✅ **サイドバー**: 表示されない
- ⚠️ **既に選択されている場合**: 選択状態は維持されるが、データは空になる可能性がある
- ⚠️ **直接URLアクセス**: 施設詳細画面にアクセスできる可能性がある（ただし、利用者データは空）

### 利用者を無効化した場合
- ✅ **施設詳細画面**: 表示されない
- ✅ **ダッシュボード**: 残高計算に含まれない
- ✅ **利用者一覧**: 表示されない
- ⚠️ **直接URLアクセス**: 利用者詳細画面にアクセスできる可能性がある（ただし、取引データは表示される）
