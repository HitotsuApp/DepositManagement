# 施設合計レイアウト変更 実行計画

## 📋 変更内容

### 1. テーブル残高列の削除
- `deposit-statement.json`のテーブル定義から`balance`列を削除
- 列幅を再調整（残高列の10%を他の列に分配）

### 2. 合計行の下に「預り金総合計」を追加
- 合計行の下に少し大きいラベルで「預り金総合計」を表示
- その下に入金-出金の合計を計算して表示（`totalIncome - totalExpense`）

### 3. タイトルの変更
- `{{statement.month}}分　預り金明細書` → `{{statement.month}}分　出納帳および預り金報告書`

### 4. 右上の表示変更
- `{{unit.name}}　様` → `{{facility.name}}`

### 5. 【お知らせ】とフッターの削除
- `notice`セクションを削除
- `footer`セクションを削除

### 6. ユニット別・利用者別の当月合計を追加
- 合計金額の下に各ユニット合計金額を表示
- 各ユニットの下に利用者それぞれの当月の合計（利用者名も表記）を表示
- 枠組みでユニットがわかるようにする

## 🎯 実装計画

### Phase 1: データ構造の拡張

#### 1.1 PrintDataインターフェースの拡張
**ファイル**: `pdf/utils/transform.ts`

```typescript
export interface PrintData {
  // 既存フィールド...
  
  // 新規追加
  unitSummaries: Array<{
    unitId: number
    unitName: string
    totalIncome: number
    totalExpense: number
    netAmount: number  // 入金-出金
    residents: Array<{
      residentId: number
      residentName: string
      totalIncome: number
      totalExpense: number
      netAmount: number  // 入金-出金
    }>
  }>
  grandTotal: {
    totalIncome: number
    totalExpense: number
    netAmount: number  // 入金-出金（預り金総合計）
  }
}
```

#### 1.2 transformToPrintData関数の拡張
**ファイル**: `pdf/utils/transform.ts`

- ユニット別・利用者別の当月合計を計算するロジックを追加
- `filterTransactionsByMonth`を使用して当月の取引のみを抽出
- 各ユニット・利用者ごとに入金・出金の合計を計算
- `grandTotal`を計算（入金-出金）

### Phase 2: テンプレート定義の変更

#### 2.1 deposit-statement.jsonの更新
**ファイル**: `pdf/templates/deposit-statement.json`

変更点：
- `header.rows[0].value`: `{{statement.month}}分　出納帳および預り金報告書`
- `header.rows[1].value`: `{{facility.name}}`
- `tables[0].columns`: `balance`列を削除、列幅を再調整
- `notice`: 削除
- `footer`: 削除
- 新規追加: `unitSummaries`セクション（テンプレート内で参照可能にする）

### Phase 3: レンダラーコンポーネントの変更

#### 3.1 TableBlock.tsxの更新
**ファイル**: `pdf/renderer/blocks/TableBlock.tsx`

- `balance`列が存在しない場合の処理を追加
- 列幅の計算ロジックを調整

#### 3.2 SummaryBlock.tsxの拡張
**ファイル**: `pdf/renderer/blocks/SummaryBlock.tsx`

変更点：
- 既存の合計行表示を維持
- その下に「預り金総合計」ラベルと`grandTotal.netAmount`を表示
- フォントサイズを少し大きく（12pt程度）

#### 3.3 UnitSummaryBlock.tsxの新規作成
**ファイル**: `pdf/renderer/blocks/UnitSummaryBlock.tsx`（新規）

- ユニット別・利用者別の合計を表示する新しいブロックコンポーネント
- ユニットごとに枠組み（ボーダー）で区切る
- ユニット名を太字で表示
- 利用者名と当月合計をリスト表示

#### 3.4 PdfRenderer.tsxの更新
**ファイル**: `pdf/renderer/PdfRenderer.tsx`

- `notice`ブロックのレンダリングを削除
- `footer`ブロックのレンダリングを削除
- `UnitSummaryBlock`を追加（最終ページの合計行の下に配置）

### Phase 4: モックデザイン

#### 4.1 レイアウトモック

```
┌─────────────────────────────────────────────────┐
│         4月分　出納帳および預り金報告書          │
│                                    ○○施設      │
├──────┬──────┬──────┬──────┬──────┬──────┤
│ 種別  │利用者名│ 日付 │ 摘要 │ 支払先│ 入金 │出金│
├──────┼──────┼──────┼──────┼──────┼──────┤
│ ユニットA│ 山田太郎│4/1  │ 入金 │      │10,000│    │
│ ユニットA│ 山田太郎│4/5  │ 出金 │ 店舗 │      │5,000│
│ ユニットB│ 佐藤花子│4/10 │ 入金 │      │20,000│    │
├──────┴──────┴──────┴──────┴──────┴──────┤
│ 合計                         30,000  5,000      │
├─────────────────────────────────────────────────┤
│ 預り金総合計                                    │
│ 25,000                                          │
├─────────────────────────────────────────────────┤
│ ┌─ ユニットA ─────────────────────────────┐ │
│ │ ユニット合計: 5,000                        │ │
│ │  ・山田太郎: 5,000                        │ │
│ └──────────────────────────────────────────┘ │
│ ┌─ ユニットB ─────────────────────────────┐ │
│ │ ユニット合計: 20,000                      │ │
│ │  ・佐藤花子: 20,000                      │ │
│ └──────────────────────────────────────────┘ │
└─────────────────────────────────────────────────┘
```

## 📝 実装手順

1. **データ構造の拡張** (`pdf/utils/transform.ts`)
   - `PrintData`インターフェースに`unitSummaries`と`grandTotal`を追加
   - `transformToPrintData`関数でユニット別・利用者別の当月合計を計算

2. **テンプレートの更新** (`pdf/templates/deposit-statement.json`)
   - タイトル変更
   - 右上の表示変更
   - 残高列の削除と列幅調整
   - noticeとfooterの削除

3. **レンダラーコンポーネントの更新**
   - `TableBlock.tsx`: 残高列対応の削除
   - `SummaryBlock.tsx`: 預り金総合計の追加
   - `UnitSummaryBlock.tsx`: 新規作成
   - `PdfRenderer.tsx`: notice/footer削除、UnitSummaryBlock追加

4. **テスト**
   - 施設合計の印刷プレビューで確認
   - まとめて印刷で結合が正しく動作するか確認

## 🎨 詳細モックデザイン

### レイアウト構造

```
┌─────────────────────────────────────────────────────────────┐
│                                                             │
│           4月分　出納帳および預り金報告書                  │
│                                            ○○施設          │
│                                                             │
├──────┬────────┬──────┬────────┬────────┬──────┬──────┤
│ 種別  │利用者名 │ 日付 │  摘要  │ 支払先 │ 入金 │ 出金 │
├──────┼────────┼──────┼────────┼────────┼──────┼──────┤
│ユニットA│山田太郎│ 4/1 │ 預り金 │        │10,000│      │
│ユニットA│山田太郎│ 4/5 │ 出金  │ 店舗A  │      │ 5,000│
│ユニットA│鈴木一郎│ 4/3 │ 預り金 │        │15,000│      │
│ユニットB│佐藤花子│4/10 │ 預り金 │        │20,000│      │
│ユニットB│佐藤花子│4/15 │ 出金  │ 店舗B  │      │ 8,000│
├──────┴────────┴──────┴────────┴────────┴──────┴──────┤
│ 合計                                        45,000  13,000│
├─────────────────────────────────────────────────────────────┤
│                                                             │
│ 預り金総合計                                                │
│ 32,000                                                      │
│                                                             │
├─────────────────────────────────────────────────────────────┤
│ ┌────────────────────────────────────────────────────────┐ │
│ │ ユニットA                                               │ │
│ │ ユニット合計: 20,000                                    │ │
│ │  ・山田太郎: 5,000                                      │ │
│ │  ・鈴木一郎: 15,000                                     │ │
│ └────────────────────────────────────────────────────────┘ │
│ ┌────────────────────────────────────────────────────────┐ │
│ │ ユニットB                                               │ │
│ │ ユニット合計: 12,000                                    │ │
│ │  ・佐藤花子: 12,000                                     │ │
│ └────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────┘
```

### スタイル仕様

**預り金総合計セクション**:
- ラベル: 14pt、太字、上マージン10pt
- 金額: 16pt、太字、右寄せ

**ユニット別セクション**:
- ボーダー: 1px solid #000
- パディング: 8pt
- マージン: 上下8pt
- ユニット名: 12pt、太字
- ユニット合計: 11pt、右寄せ
- 利用者リスト: 10pt、左マージン10pt
- 利用者名: 通常
- 利用者合計: 右寄せ

### データ構造の詳細

```typescript
unitSummaries: [
  {
    unitId: 1,
    unitName: "ユニットA",
    totalIncome: 25000,    // ユニット内全利用者の入金合計
    totalExpense: 5000,     // ユニット内全利用者の出金合計
    netAmount: 20000,       // totalIncome - totalExpense
    residents: [
      {
        residentId: 1,
        residentName: "山田太郎",
        totalIncome: 10000,  // 当月の入金合計
        totalExpense: 5000,  // 当月の出金合計
        netAmount: 5000      // totalIncome - totalExpense
      },
      {
        residentId: 2,
        residentName: "鈴木一郎",
        totalIncome: 15000,
        totalExpense: 0,
        netAmount: 15000
      }
    ]
  },
  {
    unitId: 2,
    unitName: "ユニットB",
    totalIncome: 20000,
    totalExpense: 8000,
    netAmount: 12000,
    residents: [
      {
        residentId: 3,
        residentName: "佐藤花子",
        totalIncome: 20000,
        totalExpense: 8000,
        netAmount: 12000
      }
    ]
  }
]

grandTotal: {
  totalIncome: 45000,    // 全ユニットの入金合計
  totalExpense: 13000,   // 全ユニットの出金合計
  netAmount: 32000       // totalIncome - totalExpense（預り金総合計）
}
```

## ⚠️ 注意事項

- **まとめて印刷への影響**: `BatchPdfRenderer`は`deposit-statement.json`テンプレートを使用しているため、自動的に変更が反映される
- **個人ごとの印刷**: `resident-statement.json`は変更しないため、影響なし
- **データ計算**: 当月の取引のみを対象とする（繰越行は含めない）
- **列幅調整**: 残高列削除後、他の列の幅を適切に調整（合計100%になるように）

## 📊 列幅の再計算

現在の列幅（残高列含む）:
- 種別: 12%
- 利用者名: 18%
- 日付: 10%
- 摘要: 20%
- 支払先: 20%
- 入金: 10%
- 出金: 10%
- 残高: 10% ← 削除

再計算後の列幅（残高列削除後）:
- 種別: 13% (12 + 1)
- 利用者名: 20% (18 + 2)
- 日付: 11% (10 + 1)
- 摘要: 22% (20 + 2)
- 支払先: 22% (20 + 2)
- 入金: 12% (10 + 2)
- 出金: 12% (10 + 2)
合計: 112% → 100%に正規化が必要

正規化後:
- 種別: 11.6% → 12%
- 利用者名: 17.9% → 18%
- 日付: 9.8% → 10%
- 摘要: 19.6% → 20%
- 支払先: 19.6% → 20%
- 入金: 10.7% → 11%
- 出金: 10.7% → 11%
合計: 102% → 100%に調整

最終案:
- 種別: 12%
- 利用者名: 18%
- 日付: 10%
- 摘要: 20%
- 支払先: 20%
- 入金: 10%
- 出金: 10%
合計: 100%
